---
import type { GetStaticPaths } from "astro"
import { getImage } from "astro:assets"
import { getCollection } from "astro:content"
import config from "virtual:lightnet/config"

import { getCategories } from "../../../content/get-categories"
import { getMediaItem, getRawMediaItem } from "../../../content/get-media-items"
import { getMediaTypes } from "../../../content/get-media-types"
import { prepareI18nConfig } from "../../../i18n/react/prepare-i18n-config"
import Page from "../../../layouts/Page.astro"
import { adminI18n } from "../../i18n/admin-i18n"
import EditForm from "./EditForm"

export const getStaticPaths = (async () => {
  const mediaItems = await getCollection("media")
  return mediaItems.map(({ id: mediaId }) => ({ params: { mediaId } }))
}) satisfies GetStaticPaths

const { mediaId } = Astro.params
const { data: mediaItem } = await getRawMediaItem(mediaId)
const {
  data: { image },
} = await getMediaItem(mediaId)

const previewImage = await getImage({
  src: image,
  width: 256,
  format: "webp",
})

const formData = {
  ...mediaItem,
  image: {
    path: mediaItem.image,
    previewSrc: previewImage.src,
  },
  authors: mediaItem.authors?.map((value) => ({ value })) ?? [],
  categories:
    mediaItem.categories?.map((value) => ({
      value,
    })) ?? [],
  collections: mediaItem.collections ?? [],
}

const i18nConfig = prepareI18nConfig(adminI18n, [
  "ln.admin.*",
  "ln.type",
  "ln.language",
  "ln.categories",
])
const { t, currentLocale } = adminI18n

const mediaTypes = (await getMediaTypes()).map(({ id }) => ({
  id,
  labelText: id,
}))

const categories = (await getCategories(currentLocale, t)).map(({ id }) => ({
  id,
  labelText: id,
}))

const collections = (await getCollection("media-collections")).map(
  ({ id }) => ({ id, labelText: id }),
)

const languages = config.languages.map(({ code, label }) => ({
  id: code,
  labelText: `${code} - ${t(label)}`,
}))
---

<Page
  mainClass="bg-gradient-to-t from-sky-950 to-slate-800"
  locale={currentLocale}
>
  <div class="mx-auto block max-w-screen-md px-4 md:px-8">
    <a
      class="block pb-4 pt-8 text-gray-200 underline"
      href=`/${Astro.currentLocale}/media/${mediaId}`
      >{t("ln.admin.back-to-details-page")}</a
    >
  </div>

  <div
    class="mx-auto max-w-screen-md rounded-2xl bg-gray-200 px-4 py-8 shadow-md md:px-8"
  >
    <EditForm
      mediaId={mediaId}
      mediaItem={formData}
      i18nConfig={i18nConfig}
      mediaTypes={mediaTypes}
      languages={languages}
      categories={categories}
      collections={collections}
      client:load
    />
  </div>
</Page>
