---
import config from "virtual:lightnet/config"

import { getUsedCategories } from "../../../content/get-categories"
import { contentLanguages } from "../../../content/get-languages"
import { getMediaTypes } from "../../../content/get-media-types"
import { prepareI18nConfig } from "../../../i18n/react/prepare-i18n-config"
import SearchFilterReact from "./SearchFilter.tsx"

const { t, currentLocale } = Astro.locals.i18n

const sortByLabelText = (array: { id: string; labelText: string }[]) =>
  array.sort((a, b) => a.labelText.localeCompare(b.labelText, currentLocale))

const categories = (await getUsedCategories(currentLocale, t)).map(
  ({ id, labelText }) => ({ id, labelText }),
)

const mediaTypes = sortByLabelText(
  (await getMediaTypes()).map((type) => ({
    id: type.id,
    labelText: t(type.data.label),
  })),
)

const languages = sortByLabelText(
  contentLanguages.map((language) => ({
    id: language.code,
    labelText: t(language.label),
  })),
)

const languageFilterEnabled = contentLanguages.length > 1
const typesFilterEnabled = mediaTypes.length > 1
// Not every media item has a category. So it makes
// sense to have the filter when there is only one category.
const categoriesFilterEnabled = categories.length > 0

const filterByLocale = !!config.searchPage?.filterByLocale
let initialLanguageFilter: string | undefined = undefined
const hasContentLanguage = contentLanguages.find(
  ({ code }) => code === currentLocale,
)
if (
  filterByLocale &&
  currentLocale &&
  hasContentLanguage &&
  languageFilterEnabled
) {
  initialLanguageFilter = currentLocale
}
const i18nConfig = prepareI18nConfig(Astro.locals.i18n, [
  "ln.search.title",
  "ln.language",
  "ln.search.placeholder",
  "ln.search.all-languages",
  "ln.type",
  "ln.search.all-types",
  "ln.category",
  "ln.search.all-categories",
])
---

<SearchFilterReact
  client:load
  languages={languages}
  mediaTypes={mediaTypes}
  categories={categories}
  i18nConfig={i18nConfig}
  languageFilterEnabled={languageFilterEnabled}
  typesFilterEnabled={typesFilterEnabled}
  categoriesFilterEnabled={categoriesFilterEnabled}
  initialLanguage={initialLanguageFilter}
/>
