---
import { resolveTranslatedLanguage } from "../../i18n/resolve-language"
import { localizePath } from "../../utils/paths"
import Menu from "./Menu.astro"
import MenuItem from "./MenuItem.astro"

const { t, locales } = Astro.locals.i18n

const hasLocale =
  Astro.currentLocale &&
  (Astro.url.pathname.startsWith(`/${Astro.currentLocale}/`) ||
    Astro.url.pathname === `/${Astro.currentLocale}`)

const translations = locales
  .map((locale) => ({
    locale,
    label: resolveTranslatedLanguage(locale, t).labelText,
    active: locale === Astro.currentLocale,
    href: currentPathWithLocale(locale),
  }))
  .sort((a, b) => a.label.localeCompare(b.label))

function currentPathWithLocale(locale: string) {
  const currentPath = Astro.url.pathname
  const currentPathWithoutLocale = hasLocale
    ? currentPath.slice(Astro.currentLocale.length + 1)
    : currentPath
  return localizePath(locale, currentPathWithoutLocale)
}

const disabled = !hasLocale && Astro.url.pathname !== "/"
---

{
  translations.length > 1 && (
    <Menu disabled={disabled} icon="mdi--web" label="ln.header.select-language">
      {translations.map(({ label, locale, active, href }) => (
        <MenuItem href={href} hreflang={locale} active={active}>
          {label}
        </MenuItem>
      ))}
    </Menu>
  )
}
