---
import { AstroError } from "astro/errors"
import { Image } from "astro:assets"

import { getUsedCategories } from "../content/get-categories"
import { searchPagePath } from "../utils/paths"
import CarouselSection from "./CarouselSection.astro"
import Section, { type Props as SectionProps } from "./Section.astro"

type Props = SectionProps & {
  layout?: "grid" | "carousel"
}

const { title, layout = "carousel", ...props } = Astro.props
const { t, currentLocale } = Astro.locals.i18n
const resolvedTitle = title ?? t("ln.categories")

const categories = await getUsedCategories(currentLocale, t)
type Category = (typeof categories)[number]

function getImage({ image, id }: Category) {
  if (!image) {
    throw new AstroError(
      `Expected an image for category "${id}".`,
      `To resolve this issue, provide a valid image path in /src/content/categories/${id}.json.`,
    )
  }
  return image
}
---

{
  !!categories.length && layout === "grid" && (
    <Section {...props} title={resolvedTitle}>
      <ol class="grid grid-cols-2 items-end justify-between gap-4 sm:grid-cols-3 md:grid-cols-4 md:gap-8 lg:grid-cols-5">
        {categories.map((category) => (
          <li class="h-full">
            <a
              href={searchPagePath(currentLocale, { category: category.id })}
              class="group flex h-full flex-col gap-3"
            >
              <div
                class="relative overflow-hidden rounded-2xl shadow-sm outline-2 outline-gray-400 transition-colors duration-75 ease-in-out sm:group-hover:outline"
                class:list={[
                  !category.image && "h-full min-h-28 w-full bg-gray-300",
                ]}
              >
                {category.image && (
                  <Image
                    class="h-full w-full bg-gray-500 object-contain"
                    src={getImage(category)}
                    alt=""
                    widths={[128, 256, 388, 512, 768]}
                    sizes={
                      "(max-width: 640px) calc(calc(100vw - 3rem ) / 2), " +
                      "(max-width: 768px) calc(calc(100vw - 4rem ) / 3), " +
                      "(max-width: 1024px) calc(calc(100vw - 10rem ) / 4), " +
                      "(max-width: 1280px) calc(calc(100vw - 12rem ) / 5), " +
                      "217px"
                    }
                  />
                )}

                <div
                  class="absolute start-0 top-0 flex h-full w-full flex-col justify-end bg-gradient-to-t p-4 text-gray-50"
                  class:list={[
                    category.image
                      ? "from-black/80 via-black/30 via-50% to-transparent"
                      : "from-black/35 to-transparent",
                  ]}
                >
                  <span class="line-clamp-3 select-none text-balance font-bold">
                    {category.name}
                  </span>
                </div>
              </div>
            </a>
          </li>
        ))}
      </ol>
    </Section>
  )
}
{
  !!categories.length && layout === "carousel" && (
    <CarouselSection {...props} title={resolvedTitle}>
      {categories.map((category) => (
        <li
          class="carousel-item--narrow h-full"
          role="group"
          aria-roledescription="slide"
        >
          <a
            href={searchPagePath(currentLocale, { category: category.id })}
            class="group flex h-full flex-col gap-3"
          >
            <div
              class="relative overflow-hidden rounded-2xl shadow-sm outline-2 outline-gray-400 transition-all duration-75 ease-in-out sm:group-hover:outline"
              class:list={[
                !category.image && "h-full min-h-28 w-full bg-gray-300",
              ]}
            >
              {category.image && (
                <Image
                  class="h-full w-full bg-gray-300 object-contain"
                  src={getImage(category)}
                  alt=""
                  widths={[128, 256, 388, 512, 768]}
                  sizes={
                    "(max-width: 640px) calc(calc(100vw - 3rem ) / 2.3), " +
                    "(max-width: 768px) calc(calc(100vw - 5rem ) / 3), " +
                    "(max-width: 1024px) calc(calc(100vw - 10rem ) / 4), " +
                    "(max-width: 1280px) calc(calc(100vw - 12rem ) / 5), " +
                    "217px"
                  }
                />
              )}
              <div
                class="absolute start-0 top-0 flex h-full w-full flex-col justify-end bg-gradient-to-t p-4 text-gray-50"
                class:list={[
                  category.image
                    ? "from-black/80 via-black/30 via-50% to-transparent"
                    : "from-black/35 to-transparent",
                ]}
              >
                <span class="line-clamp-3 select-none text-balance font-bold">
                  {category.name}
                </span>
              </div>
            </div>
          </a>
        </li>
      ))}
    </CarouselSection>
  )
}
